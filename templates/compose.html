{% extends "base.html" %}

{% block title %}Compose Email - Gmail Emailer{% endblock %}

{% block head %}
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-edit me-2"></i>
        Compose Email
    </h1>
    <a href="{{ url_for('recipients') }}" class="btn btn-outline-secondary">
        <i class="fas fa-users me-2"></i>
        Manage Recipients
    </a>
</div>

<form method="POST" action="{{ url_for('send_email') }}">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-envelope me-2"></i>
                        Email Content
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="subject" name="subject" required 
                               placeholder="Enter email subject (use {name}, {company}, etc. for personalization)">
                    </div>
                    
                    <div class="mb-4">
                        <label for="body" class="form-label">Message</label>
                        <textarea class="form-control" id="body" name="body" rows="15" required 
                                  placeholder="Write your email message here..."></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Recipients</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="send_to" id="send_all" value="all" checked>
                            <label class="form-check-label" for="send_all">
                                Send to all recipients
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="send_to" id="send_selected" value="selected">
                            <label class="form-check-label" for="send_selected">
                                Send to selected recipients
                            </label>
                        </div>
                        
                        <div id="recipient-selection" style="display: none;" class="mt-3">
                            <div class="border rounded p-3 bg-light">
                                <div id="recipient-list">
                                    Loading recipients...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-paper-plane me-2"></i>
                            Send Email
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Quick Templates -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-magic me-2"></i>
                        Quick Templates
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadTemplate('greeting')">
                            <i class="fas fa-hand-wave me-1"></i>
                            Greeting
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="loadTemplate('business')">
                            <i class="fas fa-briefcase me-1"></i>
                            Business Outreach
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="loadTemplate('followup')">
                            <i class="fas fa-reply me-1"></i>
                            Follow-up
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="loadTemplate('newsletter')">
                            <i class="fas fa-newspaper me-1"></i>
                            Newsletter
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Personalization Variables -->
            <div class="card mb-3">
                <div class="card-header">
                    <button class="btn btn-link text-decoration-none p-0 w-100 text-start" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#personalizationVars">
                        <h6 class="mb-0">
                            <i class="fas fa-user-tag me-2"></i>
                            Personalization Variables
                            <i class="fas fa-chevron-down float-end mt-1"></i>
                        </h6>
                    </button>
                </div>
                <div class="collapse" id="personalizationVars">
                    <div class="card-body">
                        <div class="small">
                            <h6>Contact Information:</h6>
                            <div class="mb-2">
                                <code>{name}</code> - Full name<br>
                                <code>{first_name}</code> - First name<br>
                                <code>{last_name}</code> - Last name<br>
                                <code>{email}</code> - Email address<br>
                                <code>{company}</code> - Company name<br>
                                <code>{position}</code> - Job position<br>
                                <code>{phone}</code> - Phone number
                            </div>
                            
                            <h6>Date & Time:</h6>
                            <div>
                                <code>{date}</code> - Current date<br>
                                <code>{time}</code> - Current time<br>
                                <code>{day}</code> - Day of week<br>
                                <code>{month}</code> - Current month<br>
                                <code>{year}</code> - Current year
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Email Tips -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Email Tips
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Use personalization variables to make emails more engaging
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Keep subject lines under 50 characters
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Preview your email before sending
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Anti-spam delays: 30-60 seconds between emails
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Limit: 50 emails per hour
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
// Initialize TinyMCE
tinymce.init({
    selector: '#body',
    height: 300,
    menubar: false,
    plugins: [
        'advlist autolink lists link image charmap print preview anchor',
        'searchreplace visualblocks code fullscreen',
        'insertdatetime media table paste code help wordcount'
    ],
    toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link | code',
    content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 14px }'
});

// Quick Templates
const templates = {
    greeting: {
        subject: "Hello {name}!",
        body: "Hi {name},\n\nI hope this email finds you well. I wanted to reach out and connect with you.\n\nBest regards,\n[Your Name]"
    },
    business: {
        subject: "Business Opportunity - {company}",
        body: "Dear {name},\n\nI hope you're doing well at {company}. I have an exciting business opportunity that might interest you.\n\nAs a {position}, you might find this relevant to your work. I'd love to discuss this further with you.\n\nBest regards,\n[Your Name]"
    },
    followup: {
        subject: "Following up on our conversation",
        body: "Hi {name},\n\nI wanted to follow up on our recent conversation. Thank you for taking the time to speak with me.\n\nAs promised, I'm reaching out to continue our discussion.\n\nLooking forward to hearing from you.\n\nBest regards,\n[Your Name]"
    },
    newsletter: {
        subject: "Monthly Newsletter - {month} {year}",
        body: "Hello {name},\n\nWelcome to our {month} newsletter! Here's what's new this month:\n\n• [Update 1]\n• [Update 2]\n• [Update 3]\n\nThank you for being part of our community.\n\nBest regards,\n[Your Name]"
    }
};

function loadTemplate(templateName) {
    const template = templates[templateName];
    if (template) {
        document.getElementById('subject').value = template.subject;
        tinymce.get('body').setContent(template.body.replace(/\n/g, '<br>'));
    }
}

// Recipient Selection
document.addEventListener('DOMContentLoaded', function() {
    const sendAllRadio = document.getElementById('send_all');
    const sendSelectedRadio = document.getElementById('send_selected');
    const recipientSelection = document.getElementById('recipient-selection');
    
    sendSelectedRadio.addEventListener('change', function() {
        if (this.checked) {
            recipientSelection.style.display = 'block';
            loadRecipients();
        }
    });
    
    sendAllRadio.addEventListener('change', function() {
        if (this.checked) {
            recipientSelection.style.display = 'none';
        }
    });
});

function loadRecipients() {
    const recipientList = document.getElementById('recipient-list');
    recipientList.innerHTML = 'Loading recipients...';
    
    fetch('/api/recipients')
        .then(response => response.json())
        .then(recipients => {
            if (recipients.length === 0) {
                recipientList.innerHTML = '<p class="text-muted">No recipients found. <a href="/recipients/add">Add some recipients</a> first.</p>';
                return;
            }
            
            let html = '<div class="form-group">';
            html += '<div class="mb-2"><small class="text-muted">Select recipients to send to:</small></div>';
            
            recipients.forEach(recipient => {
                html += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="recipient_ids" value="${recipient.id}" id="recipient_${recipient.id}">
                        <label class="form-check-label small" for="recipient_${recipient.id}">
                            <strong>${recipient.name}</strong><br>
                            <span class="text-muted">${recipient.email}</span>
                        </label>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div class="mt-2">';
            html += '<button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllRecipients()">Select All</button>';
            html += '<button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllRecipients()">Deselect All</button>';
            html += '</div>';
            
            recipientList.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading recipients:', error);
            recipientList.innerHTML = '<p class="text-danger">Error loading recipients. Please refresh the page.</p>';
        });
}

function selectAllRecipients() {
    const checkboxes = document.querySelectorAll('input[name="recipient_ids"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

function deselectAllRecipients() {
    const checkboxes = document.querySelectorAll('input[name="recipient_ids"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}
</script>
{% endblock %} 